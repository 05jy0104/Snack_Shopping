<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>我的订单 - 零食商店</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/notification.css">
</head>
<body>
    <div class="header">
        <h1>零食商店</h1>
        <div class="nav">
            <span id="welcome"></span>
            <a href="index.html">首页</a>
            <a href="snack-list.html">商品列表</a>
            <a href="cart-list.html">购物车</a>
            <a href="order-list.html">我的订单</a>
            <a href="profile.html">个人中心</a>
            <a href="#" id="logout">退出</a>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <h2>我的订单</h2>
            
            <div id="orderList"></div>
        </div>
    </div>

    <div id="orderDetailModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>订单详情</h2>
            <div id="orderDetailContent"></div>
        </div>
    </div>

    <div id="returnModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>申请退货</h2>
            <div style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">退货原因:</label>
                <textarea id="returnReason" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="请输入退货原因"></textarea>
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="hideReturnModal()" class="btn btn-cancel">取消</button>
                    <button onclick="submitReturn()" class="btn btn-return">提交</button>
                </div>
            </div>
        </div>
    </div>

    <div id="exchangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>申请换货</h2>
            <div style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">换货原因:</label>
                <textarea id="exchangeReason" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="请输入换货原因"></textarea>
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="hideExchangeModal()" class="btn btn-cancel">取消</button>
                    <button onclick="submitExchange()" class="btn btn-exchange">提交</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            border-radius: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .order-item-price {
            color: #666;
        }

        .order-item-quantity {
            color: #666;
            margin-left: 20px;
        }

        .order-item-subtotal {
            font-weight: bold;
            color: #f44336;
            min-width: 100px;
            text-align: right;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
            display: inline-block;
            text-align: center;
            line-height: 1.5;
        }

        .btn-detail {
            background-color: #2196f3;
            color: white;
        }

        .btn-return {
            background-color: #ff9800;
            color: white;
        }

        .btn-exchange {
            background-color: #9c27b0;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
        }
    </style>

    <script src="../js/api.js"></script>
    <script src="../js/notification.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('welcome').textContent = '欢迎, ' + (user.realName || user.username);
        }

        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        async function showOrderDetail(orderId) {
            try {
                const response = await api.user.order.detail(orderId);
                const order = response.order;
                const modal = document.getElementById('orderDetailModal');
                const content = document.getElementById('orderDetailContent');
                
                const itemsHtml = order.orderItems && order.orderItems.length > 0 
                    ? order.orderItems.map(item => `
                        <div class="order-item">
                            <div class="order-item-info">
                                <div class="order-item-name">${item.snackName}</div>
                                <div class="order-item-price">单价: ¥${item.price.toFixed(2)}</div>
                            </div>
                            <div class="order-item-quantity">数量: ${item.quantity}</div>
                            <div class="order-item-subtotal">¥${item.subtotal.toFixed(2)}</div>
                        </div>
                    `).join('')
                    : '<p style="text-align: center; padding: 20px;">暂无商品信息</p>';
                
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <p><strong>订单号:</strong> ${order.orderNo}</p>
                        <p><strong>下单时间:</strong> ${new Date(order.createTime).toLocaleString()}</p>
                        <p><strong>订单状态:</strong> <span style="color: ${getStatusColor(order.status)}">${getStatusText(order.status)}</span></p>
                        <p><strong>收货地址:</strong> ${order.address}</p>
                        <p><strong>联系电话:</strong> ${order.phone}</p>
                    </div>
                    <h3>商品清单</h3>
                    <div style="margin-top: 10px;">
                        ${itemsHtml}
                    </div>
                    <div style="margin-top: 20px; text-align: right; font-size: 18px; font-weight: bold;">
                        <span>订单总计: ¥${order.totalAmount.toFixed(2)}</span>
                    </div>
                `;
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('加载订单详情失败:', error);
                notification.error('加载订单详情失败，请稍后重试');
            }
        }

        let currentReturnOrderId = null;
        let currentExchangeOrderId = null;

        function showReturnModal(orderId) {
            currentReturnOrderId = orderId;
            document.getElementById('returnReason').value = '';
            document.getElementById('returnModal').style.display = 'block';
        }

        function hideReturnModal() {
            document.getElementById('returnModal').style.display = 'none';
            currentReturnOrderId = null;
        }

        async function submitReturn() {
            const reason = document.getElementById('returnReason').value.trim();
            if (!reason) {
                notification.warning('请输入退货原因');
                return;
            }
            
            try {
                await api.user.order.return({ orderId: currentReturnOrderId, reason });
                notification.success('退货申请已提交');
                hideReturnModal();
                loadOrders();
            } catch (error) {
                console.error('退货申请失败:', error);
                notification.error('退货申请失败，请稍后重试');
            }
        }

        function showExchangeModal(orderId) {
            currentExchangeOrderId = orderId;
            document.getElementById('exchangeReason').value = '';
            document.getElementById('exchangeModal').style.display = 'block';
        }

        function hideExchangeModal() {
            document.getElementById('exchangeModal').style.display = 'none';
            currentExchangeOrderId = null;
        }

        async function submitExchange() {
            const reason = document.getElementById('exchangeReason').value.trim();
            if (!reason) {
                notification.warning('请输入换货原因');
                return;
            }
            
            try {
                await api.user.order.exchange({ orderId: currentExchangeOrderId, reason });
                notification.success('换货申请已提交');
                hideExchangeModal();
                loadOrders();
            } catch (error) {
                console.error('换货申请失败:', error);
                notification.error('换货申请失败，请稍后重试');
            }
        }

        async function cancelOrder(orderId) {
            notification.confirm('确定要取消这个订单吗？', async () => {
                try {
                    await api.user.order.cancel({ orderId });
                    notification.success('订单已取消');
                    loadOrders();
                } catch (error) {
                    console.error('取消订单失败:', error);
                    notification.error('取消订单失败，请稍后重试');
                }
            });
        }

        async function loadOrders() {
            try {
                const response = await api.user.order.list();
                const orders = response.orders || [];
                const container = document.getElementById('orderList');
                
                if (orders.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 50px;">暂无订单</p>';
                    return;
                }
                
                container.innerHTML = orders.map(order => `
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>订单号:</strong> ${order.orderNo}<br>
                                <strong>下单时间:</strong> ${new Date(order.createTime).toLocaleString()}
                            </div>
                            <div style="text-align: right;">
                                <strong>状态:</strong> 
                                <span style="color: ${getStatusColor(order.status)}">${getStatusText(order.status)}</span><br>
                                <strong>总金额:</strong> ¥${order.totalAmount.toFixed(2)}
                            </div>
                        </div>
                        <div>
                            <strong>收货信息:</strong><br>
                            地址: ${order.address}<br>
                            电话: ${order.phone}
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <button class="btn btn-detail" onclick="showOrderDetail(${order.id})">查看详情</button>
                            ${(order.status === '待发货' || order.status === '已发货') ? `
                                <button class="btn btn-cancel" onclick="cancelOrder(${order.id})">取消订单</button>
                            ` : ''}
                            ${order.status === '已完成' ? `
                                <button class="btn btn-return" onclick="showReturnModal(${order.id})">退货</button>
                                <button class="btn btn-exchange" onclick="showExchangeModal(${order.id})">换货</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载订单失败:', error);
                document.getElementById('orderList').innerHTML = '<p style="text-align: center; padding: 50px;">加载失败，请稍后重试</p>';
            }
        }

        const orderDetailModal = document.getElementById('orderDetailModal');
        const returnModal = document.getElementById('returnModal');
        const exchangeModal = document.getElementById('exchangeModal');
        const closeBtns = document.getElementsByClassName('close');

        for (let i = 0; i < closeBtns.length; i++) {
            closeBtns[i].onclick = function() {
                orderDetailModal.style.display = 'none';
                returnModal.style.display = 'none';
                exchangeModal.style.display = 'none';
            }
        }

        window.onclick = function(event) {
            if (event.target == orderDetailModal) {
                orderDetailModal.style.display = 'none';
            }
            if (event.target == returnModal) {
                returnModal.style.display = 'none';
            }
            if (event.target == exchangeModal) {
                exchangeModal.style.display = 'none';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                '待发货': '待发货',
                '已发货': '已发货',
                '已完成': '已完成',
                '已取消': '已取消',
                '退货中': '退货中',
                '换货中': '换货中',
                'pending': '待处理',
                'processing': '处理中',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }

        function getStatusColor(status) {
            const colorMap = {
                '待发货': '#ff9800',
                '已发货': '#2196f3',
                '已完成': '#4caf50',
                '已取消': '#f44336',
                '退货中': '#ff5722',
                '换货中': '#9c27b0',
                'pending': '#ff9800',
                'processing': '#2196f3',
                'completed': '#4caf50',
                'cancelled': '#f44336'
            };
            return colorMap[status] || '#333';
        }

        loadOrders();

        window.showOrderDetail = showOrderDetail;
        window.returnOrder = returnOrder;
        window.exchangeOrder = exchangeOrder;
        window.cancelOrder = cancelOrder;
    </script>
</body>
</html>
