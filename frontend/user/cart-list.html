<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>购物车 - 零食商店</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/notification.css">
</head>
<body>
    <div class="header">
        <h1>零食商店</h1>
        <div class="nav">
            <span id="welcome"></span>
            <a href="index.html">首页</a>
            <a href="snack-list.html">商品列表</a>
            <a href="cart-list.html">购物车</a>
            <a href="order-list.html">我的订单</a>
            <a href="profile.html">个人中心</a>
            <a href="#" id="logout">退出</a>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <h2>购物车</h2>
            
            <div id="cartContent">
                <table id="cartTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>商品名称</th>
                            <th>价格</th>
                            <th>数量</th>
                            <th>小计</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="cartList"></tbody>
                </table>
                
                <div style="margin-top: 20px; text-align: right;">
                    <h3>总计: <span id="totalPrice">¥0.00</span></h3>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="clearCart()" class="btn btn-danger">清空购物车</button>
                    <button onclick="showOrderForm()" class="btn btn-primary">结算</button>
                </div>
            </div>
            
            <div id="emptyCart" style="display: none; text-align: center; padding: 50px;">
                <p>购物车为空</p>
                <a href="snack-list.html" class="btn btn-primary">去购物</a>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/notification.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('welcome').textContent = '欢迎, ' + (user.realName || user.username);
        }

        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        let cartItems = [];
        let currentOrderModal = null;

        async function loadCart() {
            try {
                const response = await api.user.cart.list();
                cartItems = response.cartList || [];
                
                if (cartItems.length === 0) {
                    document.getElementById('cartContent').style.display = 'none';
                    document.getElementById('emptyCart').style.display = 'block';
                    return;
                }
                
                const tbody = document.getElementById('cartList');
                let total = 0;
                
                tbody.innerHTML = cartItems.map(item => {
                    const subtotal = item.price * item.quantity;
                    total += subtotal;
                    return `
                        <tr data-id="${item.id}">
                            <td><input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="updateTotal()"></td>
                            <td>${item.snackName}</td>
                            <td>¥${item.price.toFixed(2)}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <button onclick="changeQuantity(${item.id}, -1)" class="btn btn-sm" style="padding: 2px 8px;">-</button>
                                    <input type="number" id="quantity-${item.id}" value="${item.quantity}" min="1" 
                                        style="width: 50px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;"
                                        onchange="updateQuantity(${item.id}, this.value)">
                                    <button onclick="changeQuantity(${item.id}, 1)" class="btn btn-sm" style="padding: 2px 8px;">+</button>
                                </div>
                            </td>
                            <td class="subtotal">¥${subtotal.toFixed(2)}</td>
                            <td>
                                <button onclick="viewDetail(${item.snackId})" class="btn btn-sm" style="padding: 5px 10px; margin-right: 5px;">详情</button>
                                <button onclick="deleteCartItem(${item.id})" class="btn btn-danger">删除</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('totalPrice').textContent = '¥' + total.toFixed(2);
            } catch (error) {
                console.error('加载购物车失败:', error);
                notification.error('加载失败，请稍后重试');
            }
        }

        async function deleteCartItem(id) {
            notification.confirm('确定要删除这个商品吗？', async () => {
                try {
                    const response = await api.user.cart.delete(id);
                    if (response.success) {
                        loadCart();
                    } else {
                        notification.error(response.message || '删除失败');
                    }
                } catch (error) {
                    console.error('删除失败:', error);
                    notification.error('删除失败，请稍后重试');
                }
            });
        }

        async function changeQuantity(id, delta) {
            const item = cartItems.find(item => item.id === id);
            if (!item) return;
            
            const newQuantity = item.quantity + delta;
            if (newQuantity < 1) {
                notification.warning('商品数量不能小于1');
                return;
            }
            
            await updateQuantity(id, newQuantity);
        }

        async function updateQuantity(id, quantity) {
            const newQuantity = parseInt(quantity);
            if (isNaN(newQuantity) || newQuantity < 1) {
                notification.warning('请输入有效的数量');
                loadCart();
                return;
            }
            
            try {
                const response = await api.user.cart.update(id, newQuantity);
                if (response.success) {
                    loadCart();
                } else {
                    notification.error(response.message || '更新数量失败');
                    loadCart();
                }
            } catch (error) {
                console.error('更新数量失败:', error);
                notification.error('更新数量失败，请稍后重试');
                loadCart();
            }
        }

        function updateTotal() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            let total = 0;
            
            checkboxes.forEach(checkbox => {
                const id = parseInt(checkbox.dataset.id);
                const item = cartItems.find(item => item.id === id);
                if (item) {
                    total += item.price * item.quantity;
                }
            });
            
            document.getElementById('totalPrice').textContent = '¥' + total.toFixed(2);
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateTotal();
        }

        function viewDetail(snackId) {
            window.location.href = `snack-detail.html?id=${snackId}`;
        }

        async function clearCart() {
            notification.confirm('确定要清空购物车吗？', async () => {
                try {
                    const response = await api.user.cart.clear();
                    if (response.success) {
                        loadCart();
                    } else {
                        notification.error(response.message || '清空失败');
                    }
                } catch (error) {
                    console.error('清空失败:', error);
                    notification.error('清空失败，请稍后重试');
                }
            });
        }

        function showOrderForm() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            if (checkboxes.length === 0) {
                notification.warning('请至少选择一个商品进行结算');
                return;
            }
            
            const selectedItems = [];
            checkboxes.forEach(checkbox => {
                const id = parseInt(checkbox.dataset.id);
                const item = cartItems.find(item => item.id === id);
                if (item) {
                    selectedItems.push(item);
                }
            });
            
            const modalContent = `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">已选商品:</h4>
                    <ul style="max-height: 200px; overflow-y: auto; padding-left: 20px;">
                        ${selectedItems.map(item => `
                            <li>${item.snackName} x ${item.quantity} - ¥${(item.price * item.quantity).toFixed(2)}</li>
                        `).join('')}
                    </ul>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">收货地址</label>
                    <input type="text" id="orderAddress" value="${user.address || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">联系电话</label>
                    <input type="text" id="orderPhone" value="${user.phone || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
            `;

            currentOrderModal = notification.modal('填写订单信息', modalContent, [
                {
                    text: '取消',
                    className: 'btn-secondary',
                    onClick: () => {
                        currentOrderModal.classList.remove('show');
                        setTimeout(() => {
                            currentOrderModal.remove();
                            currentOrderModal = null;
                        }, 300);
                    }
                },
                {
                    text: '确认下单',
                    className: 'btn-primary',
                    onClick: () => {
                        const address = document.getElementById('orderAddress').value;
                        const phone = document.getElementById('orderPhone').value;
                        
                        if (!address || !phone) {
                            notification.warning('请填写完整的订单信息');
                            return;
                        }
                        
                        createOrder(address, phone, selectedItems.map(item => item.id));
                    }
                }
            ]);
        }

        async function createOrder(address, phone, cartItemIds) {
            try {
                const response = await api.user.order.create({ address, phone, cartItemIds });
                if (response.success) {
                    notification.success('订单创建成功！');
                    if (currentOrderModal) {
                        currentOrderModal.classList.remove('show');
                        setTimeout(() => {
                            currentOrderModal.remove();
                            currentOrderModal = null;
                        }, 300);
                    }
                    window.location.href = 'order-list.html';
                } else {
                    notification.error(response.message || '订单创建失败');
                }
            } catch (error) {
                console.error('订单创建失败:', error);
                notification.error('订单创建失败，请稍后重试');
            }
        }

        loadCart();
    </script>
</body>
</html>
