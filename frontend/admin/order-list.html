<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>订单管理 - 零食商店管理后台</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/notification.css">
</head>
<body>
    <div class="header admin-header">
        <h1>零食商店管理后台</h1>
        <div class="nav">
            <a href="index.html">首页</a>
            <a href="user-list.html">用户管理</a>
            <a href="category-list.html">分类管理</a>
            <a href="snack-list.html">商品管理</a>
            <a href="order-list.html">订单管理</a>
            <a href="#" id="logout">退出</a>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <h2>订单管理</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>订单号</th>
                        <th>用户</th>
                        <th>总金额</th>
                        <th>状态</th>
                        <th>收货地址</th>
                        <th>联系电话</th>
                        <th>下单时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/notification.js"></script>
    <script>
        let currentOrderId = null;

        function loadOrders() {
            api.admin.order.list()
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('orderList');
                        tbody.innerHTML = '';
                        data.orders.forEach(order => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${order.id}</td>
                                <td>${order.orderNo}</td>
                                <td>${order.username} </td>
                                <td>¥${order.totalAmount.toFixed(2)}</td>
                                <td>${order.status}</td>
                                <td>${order.address}</td>
                                <td>${order.phone}</td>
                                <td>${new Date(order.createTime).toLocaleString()}</td>
                                <td>
                                    <button onclick="showStatusModal(${order.id}, '${order.orderNo}', '${order.status}')" class="btn btn-primary">更新状态</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        notification.error(data.message);
                        window.location.href = 'login.html';
                    }
                })
                .catch(error => {
                    console.error('加载订单失败:', error);
                    notification.error('加载订单失败');
                });
        }

        function showStatusModal(id, orderNo, status) {
            currentOrderId = id;
            
            const modalContent = `
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">订单号</label>
                    <input type="text" id="orderNo" value="${orderNo}" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; box-sizing: border-box;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">订单状态</label>
                    <select id="orderStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        <option value="待发货" ${status === '待发货' ? 'selected' : ''}>待发货</option>
                        <option value="已发货" ${status === '已发货' ? 'selected' : ''}>已发货</option>
                        <option value="已完成" ${status === '已完成' ? 'selected' : ''}>已完成</option>
                        <option value="已取消" ${status === '已取消' ? 'selected' : ''}>已取消</option>
                    </select>
                </div>
            `;

            notification.modal('更新订单状态', modalContent, [
                {
                    text: '取消',
                    className: 'btn-secondary',
                    onClick: () => {
                        currentOrderId = null;
                    }
                },
                {
                    text: '更新',
                    className: 'btn-primary',
                    onClick: () => {
                        updateStatus();
                    }
                }
            ]);
        }

        function updateStatus() {
            const status = document.getElementById('orderStatus').value;
            api.admin.order.updateStatus({
                id: currentOrderId,
                status: status
            })
                .then(data => {
                    if (data.success) {
                        notification.success(data.message);
                        currentOrderId = null;
                        loadOrders();
                    } else {
                        notification.error(data.message);
                    }
                })
                .catch(error => {
                    console.error('更新订单状态失败:', error);
                    notification.error('更新订单状态失败');
                });
        }

        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('admin');
            window.location.href = 'login.html';
        });

        loadOrders();
    </script>
</body>
</html>