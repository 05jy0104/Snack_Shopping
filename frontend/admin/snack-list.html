<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>商品管理 - 零食商店管理后台</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/notification.css">
</head>
<body>
    <div class="header admin-header">
        <h1>零食商店管理后台</h1>
        <div class="nav">
            <a href="index.html">首页</a>
            <a href="user-list.html">用户管理</a>
            <a href="category-list.html">分类管理</a>
            <a href="snack-list.html">商品管理</a>
            <a href="order-list.html">订单管理</a>
            <a href="#" id="logout">退出</a>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <h2>商品管理</h2>
            
            <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                <button onclick="showAddModal()" class="btn btn-primary">添加商品</button>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-weight: bold;">分类筛选:</label>
                    <select id="categoryFilter" onchange="filterByCategory()" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px;">
                        <option value="">全部商品</option>
                    </select>
                </div>
            </div>
            
            <div id="snackList" class="snack-grid"></div>
            <div id="pagination"></div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/notification.js"></script>
    <script>
        const admin = JSON.parse(localStorage.getItem('admin'));
        if (!admin) {
            window.location.href = 'login.html';
        }

        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('admin');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        let currentSnackId = null;
        let categories = [];
        let allSnacks = [];
        let currentPage = 1;
        const pageSize = 9;
        let filteredSnacks = [];

        async function loadCategories() {
            try {
                const response = await api.admin.category.list();
                categories = response.categories || [];
                
                const filterSelect = document.getElementById('categoryFilter');
                filterSelect.innerHTML = '<option value="">全部商品</option>';
                
                categories.forEach(category => {
                    const filterOption = document.createElement('option');
                    filterOption.value = category.id;
                    filterOption.textContent = category.name;
                    filterSelect.appendChild(filterOption);
                });
            } catch (error) {
                console.error('加载分类失败:', error);
            }
        }

        async function loadSnacks() {
            try {
                const response = await api.admin.snack.list();
                allSnacks = response.snacks || [];
                
                const categoryId = getCategoryIdFromUrl();
                if (categoryId) {
                    document.getElementById('categoryFilter').value = categoryId;
                    filteredSnacks = allSnacks.filter(snack => snack.categoryId === parseInt(categoryId));
                } else {
                    filteredSnacks = allSnacks;
                }
                
                currentPage = 1;
                displaySnacks();
            } catch (error) {
                console.error('加载商品失败:', error);
                document.getElementById('snackList').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">加载失败，请稍后重试</div>';
            }
        }

        function displaySnacks() {
            const container = document.getElementById('snackList');
            
            if (filteredSnacks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">暂无商品</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(filteredSnacks.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredSnacks.length);
            const pageSnacks = filteredSnacks.slice(startIndex, endIndex);
            
            container.innerHTML = pageSnacks.map(snack => {
                const category = categories.find(c => c.id === snack.categoryId);
                const imageUrl = snack.image;
                return `
                    <div class="snack-card">
                        <div class="snack-image">
                            ${imageUrl 
                                ? `<img src="${imageUrl}" alt="${snack.name}" onerror="this.parentElement.innerHTML='<div style=\'width:200px;height:200px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;color:#999;border-radius:4px;\'>暂无图片</div>'">`
                                : `<div style="width:200px;height:200px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;color:#999;border-radius:4px;">暂无图片</div>`
                            }
                        </div>
                        <div class="snack-info">
                            <h3 class="snack-name">${snack.name}</h3>
                            <p class="snack-category">${category ? category.name : '未分类'}</p>
                            <div class="snack-details">
                                <span class="snack-price">¥${snack.price.toFixed(2)}</span>
                                <span class="snack-stock">库存: ${snack.stock}</span>
                            </div>
                            ${snack.description ? `<p class="snack-description">${snack.description}</p>` : ''}
                            <div class="snack-actions">
                                <button onclick="editSnack(${snack.id})" class="btn btn-primary">编辑</button>
                                <button onclick="deleteSnack(${snack.id})" class="btn btn-danger">删除</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            displayPagination(totalPages);
        }

        function displayPagination(totalPages) {
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; padding: 20px;">';
            
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="btn ${currentPage === 1 ? 'btn-disabled' : 'btn-primary'}" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 16px;">上一页</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `<button onclick="changePage(${i})" class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" style="padding: 8px 16px;">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span style="padding: 8px 4px;">...</span>`;
                }
            }
            
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="btn ${currentPage === totalPages ? 'btn-disabled' : 'btn-primary'}" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 16px;">下一页</button>`;
            
            paginationHTML += `<span style="margin-left: 10px; color: #666;">共 ${filteredSnacks.length} 条，第 ${currentPage}/${totalPages} 页</span>`;
            
            paginationHTML += '</div>';
            
            paginationContainer.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredSnacks.length / pageSize);
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            displaySnacks();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function filterByCategory() {
            const categoryId = document.getElementById('categoryFilter').value;
            
            if (!categoryId) {
                filteredSnacks = allSnacks;
            } else {
                filteredSnacks = allSnacks.filter(snack => snack.categoryId === parseInt(categoryId));
            }
            
            currentPage = 1;
            displaySnacks();
        }

        function getCategoryIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('categoryId');
        }

        function showAddModal() {
            currentSnackId = null;
            
            const categoryOptions = categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
            
            const modalContent = `
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">商品名称</label>
                    <input type="text" id="snackName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">分类</label>
                    <select id="snackCategoryId" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        <option value="">请选择分类</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">价格</label>
                    <input type="number" id="snackPrice" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">库存</label>
                    <input type="number" id="snackStock" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">描述</label>
                    <textarea id="snackDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">图片</label>
                    <input type="file" id="snackImageFile" accept="image/*" onchange="previewImage(this)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    <input type="hidden" id="snackImage" value="">
                    <div id="imagePreview" style="margin-top: 10px; text-align: center;"></div>
                </div>
            `;

            notification.modal('添加商品', modalContent, [
                {
                    text: '取消',
                    className: 'btn-secondary',
                    onClick: () => {
                        currentSnackId = null;
                    }
                },
                {
                    text: '保存',
                    className: 'btn-primary',
                    onClick: () => {
                        saveSnack();
                    }
                }
            ]);
        }

        async function editSnack(id) {
            try {
                const response = await api.admin.snack.edit(id);
                const snack = response.snack;
                
                currentSnackId = id;
                
                const categoryOptions = categories.map(cat => 
                    `<option value="${cat.id}" ${cat.id === snack.categoryId ? 'selected' : ''}>${cat.name}</option>`
                ).join('');
                
                const modalContent = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">商品名称</label>
                        <input type="text" id="snackName" value="${snack.name || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">分类</label>
                        <select id="snackCategoryId" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                            <option value="">请选择分类</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">价格</label>
                        <input type="number" id="snackPrice" step="0.01" value="${snack.price || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">库存</label>
                        <input type="number" id="snackStock" value="${snack.stock || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">描述</label>
                        <textarea id="snackDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">${snack.description || ''}</textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">图片</label>
                        <input type="file" id="snackImageFile" accept="image/*" onchange="previewImage(this)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        <input type="hidden" id="snackImage" value="${snack.image || ''}">
                        <div id="imagePreview" style="margin-top: 10px; text-align: center;">
                            ${snack.image ? `<img src="${snack.image}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">` : ''}
                        </div>
                    </div>
                `;

                notification.modal('编辑商品', modalContent, [
                    {
                        text: '取消',
                        className: 'btn-secondary',
                        onClick: () => {
                            currentSnackId = null;
                        }
                    },
                    {
                        text: '保存',
                        className: 'btn-primary',
                        onClick: () => {
                            saveSnack();
                        }
                    }
                ]);
            } catch (error) {
                console.error('加载商品信息失败:', error);
                notification.error('加载失败，请稍后重试');
            }
        }

        async function saveSnack() {
            const snackData = {
                name: document.getElementById('snackName').value,
                categoryId: parseInt(document.getElementById('snackCategoryId').value),
                price: parseFloat(document.getElementById('snackPrice').value),
                stock: parseInt(document.getElementById('snackStock').value),
                description: document.getElementById('snackDescription').value,
                image: document.getElementById('snackImage').value
            };
            
            if (!snackData.name || !snackData.categoryId || !snackData.price || !snackData.stock) {
                notification.warning('请填写完整的商品信息');
                return;
            }
            
            try {
                let response;
                if (currentSnackId) {
                    snackData.id = currentSnackId;
                    response = await api.admin.snack.update(snackData);
                } else {
                    response = await api.admin.snack.add(snackData);
                }
                
                if (response.success) {
                    notification.success('保存成功');
                    currentSnackId = null;
                    loadSnacks();
                } else {
                    notification.error(response.message || '保存失败');
                }
            } catch (error) {
                console.error('保存失败:', error);
                notification.error('保存失败，请稍后重试');
            }
        }

        async function deleteSnack(id) {
            notification.confirm('确定要删除这个商品吗？', async () => {
                try {
                    const response = await api.admin.snack.delete(id);
                    if (response.success) {
                        notification.success('删除成功');
                        loadSnacks();
                    } else {
                        notification.error(response.message || '删除失败');
                    }
                } catch (error) {
                    console.error('删除失败:', error);
                    notification.error('删除失败，请稍后重试');
                }
            });
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const hiddenInput = document.getElementById('snackImage');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">`;
                };
                
                reader.readAsDataURL(file);
                
                api.admin.snack.upload(file)
                    .then(data => {
                        if (data.success) {
                            hiddenInput.value = data.imageUrl;
                            notification.success('图片上传成功');
                        } else {
                            notification.error('图片上传失败: ' + data.message);
                            preview.innerHTML = '';
                            input.value = '';
                        }
                    })
                    .catch(error => {
                        console.error('上传失败:', error);
                        notification.error('图片上传失败');
                        preview.innerHTML = '';
                        input.value = '';
                    });
            } else {
                preview.innerHTML = '';
                hiddenInput.value = '';
            }
        }

        loadCategories();
        loadSnacks();
    </script>
</body>
</html>
